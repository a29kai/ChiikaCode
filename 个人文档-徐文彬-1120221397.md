### ChiikaCode 徐文彬个人文档

---

#### 一、项目背景

​  ChiikaCode VSCode 插件旨在通过 AI 编程助手功能提升开发效率。本插件通过与后端交互，提供代码生成功能、项目生成、文件上传等能力。

​  我在本项目中的主要工作为**分析pytorch的设计模式**，**设计开发插件后端api**并运用学习到的设计模式，为此，我开发了一个基于 FastAPI 的 Web 服务，用户可以通过简单的 API 请求来生成特定编程语言的项目代码结构，并结合知识库进行代码生成。该服务包括多个模块，支持代码生成、代码自动检测、文件上传与处理、以及与外部知识库结合的检索增强生成（RAG）功能。

#### 二、后端架构设计

##### 2.1 整体设计架构

1. **FastAPI 应用初始化**
   - 使用 FastAPI 框架构建 Web 应用，并定义了 `/generate_code` POST 路由用于接收用户请求并生成代码文件。
   - 通过定义 `RequestData` 类，管理用户请求的输入数据，涵盖需求问题 `question` 和编程语言 `language`。

2. **生成代码的核心流程**
   - `generate_code_structure` 函数通过调用 `getRawStructureStream` 获取项目结构数据，解析成 `Node` 对象并生成对应的代码内容。
   - 使用 `getRawCodeStream` 根据用户需求和结构生成代码，并通过模板生成最终代码。

3. **支持的操作**
   - 利用 `langchain` 框架结合大模型生成代码。
   - 通过嵌入向量检索系统增强代码生成过程，使用知识库参考提高生成质量。
   - 生成的代码以 JSON 格式保存到本地，并提供下载功能。

4. **异常处理**
   - 在生成代码时，若发生错误会抛出 HTTP 异常，并返回 500 或 400 状态码。

5. **API 端点**
   - `/generate_code`：接收用户提供的需求和编程语言，调用生成函数生成代码结构。

6. **启动 FastAPI 服务**
   - 在应用启动时，通过 `uvicorn.run()` 启动服务，监听本地端口 8000。

##### 2.2 RAG 构建

- 允许用户上传文件或文件夹，并通过检索增强生成（RAG）链结合文件内容生成代码。
- 支持多种文件类型的加载，使用文件加载器根据文件扩展名自动选择合适的加载方式。
- 文件内容经过嵌入转换后存入向量数据库，并通过 RAG 链生成回答或代码。
  
**API 路由**

- `/upload_file_path`：用于上传文件或文件夹路径并初始化 RAG 链。
- `/rag_ask`：基于上传文件的内容，通过 RAG 链生成代码或答案。

##### 2.3 代码自动检测

- 通过 OpenAI 模型（如 `starcoder2:3b`）生成 Python 函数代码，确保生成的代码无语法错误且可执行。
- 用户通过提供函数名、参数和文档字符串来生成函数代码，服务会返回符合要求的可执行 Python 代码。

**核心代码生成逻辑**

- `getCompleteBody` 生成函数体，结合文档字符串生成完整的 Python 函数代码。
- `getExecutable` 尝试生成并测试可执行代码，最多生成 10 次直到代码可运行。

**API 路由**

- `/generate_executable_code`：接收用户请求，生成并返回符合要求的可执行代码。

#### 三、设计模式分析

##### 3.1 工厂模式

**实现概述**

- **LoaderFactory 类**根据文件扩展名返回不同的文件加载器对象。
- 各种具体加载器继承自 `BaseLoader`，并实现文件读取的具体方法。

**类图**

![image-20241114190827422](C:\Users\xuwen\AppData\Roaming\Typora\typora-user-images\image-20241114190827422.png)

##### 3.2 单例模式

**实现概述**

- **SingletonResources 类**确保全局只有一个嵌入向量实例 `embedding` 和 RAG 链实例 `rag_chain`，并通过多线程锁确保线程安全。
- 通过重写 `__new__` 方法保证类只实例化一次，避免重复创建资源。

**类图**

![image-20241114190903158](C:\Users\xuwen\AppData\Roaming\Typora\typora-user-images\image-20241114190903158.png)

##### 3.3 观察者模式

**实现概述**

- 通过 `SessionState` 管理应用程序状态，状态变化会触发不同的处理逻辑。
- `StreamlitApp` 作为观察者，监听 `SessionState` 中的状态变化并执行相应操作。

**类图**

![image-20241114190916295](C:\Users\xuwen\AppData\Roaming\Typora\typora-user-images\image-20241114190916295.png)

### 个人收获

​  在本项目中，我深入理解并实践了多种设计模式的应用，尤其是工厂模式、单例模式和观察者模式，提升了我的软件架构设计能力。通过实现文件加载器工厂类，我掌握了如何通过**工厂模式**动态选择不同的文件处理策略，这对于处理复杂的输入文件类型非常有效。单例模式的使用帮助我理解了如何在多线程环境下管理全局共享资源，确保系统的高效与稳定。而**观察者模式**的应用让我体会到如何通过管理和监听状态变化，实现更为灵活的交互设计，尤其在 Web 服务中非常重要。此外，通过 FastAPI 和 RAG 技术的结合，我学习了如何设计一个高效的 API 服务，利用大模型与知识库实现自动化代码生成，提高了代码的生产力和准确性。整体而言，本项目不仅提升了我在后端开发和架构设计方面的能力，也加深了我对现代软件开发模式的理解。
